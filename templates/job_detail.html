{% extends "base.html" %}
{% block content %}
<h4>Work #{{ job.id }} {% if job.status %}<small class="text-muted">— {{ job.status }}</small>{% endif %}</h4>

<div class="row">
  <div class="col-md-6">
    <div class="card mb-3">
      <div class="card-body">
        <h6>Customer</h6>
        <p>
          <strong>{{ job.customer.name }}</strong><br>
          {% if job.customer.phone %}{{ job.customer.phone }}<br>{% endif %}
          {% if job.customer.address %}{{ job.customer.address }}{% endif %}
        </p>

        <h6 class="mt-3">Device / Problem</h6>
        <p>
          {{ job.tv_model or '-' }} <br>
          <small class="text-muted">{{ job.repair_work or '-' }}</small>
        </p>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <h6>Payments</h6>

        <form action="{{ url_for('add_payment', job_id=job.id) }}" method="post" class="row g-2 mb-3" aria-label="Add payment">
          <div class="col-6">
            <input name="amount" type="number" step="0.01" class="form-control" placeholder="Amount" required>
          </div>
          <div class="col-4">
            <select name="payment_mode" class="form-select" aria-label="Payment mode">
              <option value="cash">cash</option>
              <option value="upi">upi</option>
              <option value="card">card</option>
            </select>
          </div>
          <div class="col-2">
            <button class="btn btn-success w-100">Add</button>
          </div>
        </form>

        <hr>

        <ul class="list-group list-group-flush" aria-live="polite">
          {% for p in job.payments %}
            <li class="list-group-item d-flex justify-content-between align-items-start">
              <div>
                ₹{{ '%.2f'|format(p.amount) }}
                {% if p.payment_mode %} — <small class="text-muted">{{ p.payment_mode }}</small>{% endif %}
                {% if p.note %}<div class="small text-muted">{{ p.note }}</div>{% endif %}
              </div>
              <div class="text-muted small">
                {{ p.payment_date.strftime('%Y-%m-%d %H:%M') if p.payment_date else '-' }}
              </div>
            </li>
          {% else %}
            <li class="list-group-item text-muted">No payments yet</li>
          {% endfor %}
        </ul>
      </div>
    </div>

  </div>

  <div class="col-md-6">
    <div class="card mb-3">
      <div class="card-body">
        <h6>Financials</h6>
        <p>Charge: <strong>₹{{ '%.2f'|format(job.amount_charged or 0) }}</strong></p>
        <p>Expense: <strong>₹{{ '%.2f'|format(job.expense or 0) }}</strong></p>
        <p>Profit: <strong>₹{{ '%.2f'|format(job.profit) }}</strong></p>
        <p>Paid: <strong>₹{{ '%.2f'|format(total_paid) }}</strong></p>
        <p>Remaining: <strong>₹{{ '%.2f'|format(remaining) }}</strong></p>
        <p>Status: <strong>{{ job.status }}</strong></p>

        <!-- Responsive action buttons: will stack on small screens -->
        <div class="d-flex gap-2 flex-wrap" style="align-items:center;">
          <form action="{{ url_for('complete', job_id=job.id) }}" method="post" style="display:inline" aria-label="Mark job completed">
            <button class="btn btn-primary" {% if job.status=='completed' %}disabled{% endif %}>Mark completed</button>
          </form>

          <a class="btn btn-outline-secondary" href="{{ url_for('jobs') }}" role="button">Back</a>

          <a class="btn btn-outline-dark" href="{{ url_for('expenses_list') }}" title="View Daily Expense Page" role="button">Daily Expenses</a>

          <!-- Invoice buttons -->
          <a class="btn btn-outline-info" href="{{ url_for('invoice_html', job_id=job.id) }}" target="_blank" rel="noopener" title="Open printable invoice">View Invoice</a>

          <a class="btn btn-outline-success" href="{{ url_for('invoice_pdf', job_id=job.id) }}" target="_blank" rel="noopener" title="Download invoice as PDF (if available)">Download PDF</a>
        </div>
      </div>
    </div>

    {% if screenshot_url %}
      <div class="card">
        <div class="card-body">
          <h6>Reference image</h6>
          <p class="text-muted small">Uploaded screenshot (for your reference)</p>
          <img src="{{ screenshot_url }}" alt="reference" class="img-fluid border">
        </div>
      </div>
    {% endif %}
  </div>
</div>

{% endblock %}
